<html>
 <head>
   <meta charset="utf-8">
   <style type="text/css">
     html, body { height: 100%; margin: 0; padding: 0; }
     #map { height: 100%; }

     #map {
       bottom: 0px;
       height: 100%;
       left: 362px;
       position: absolute;
       right: 0px;
     }

     .options-box {
       background: #fff;
       border: 1px solid #999;
       border-radius: 3px;
       height: 100%;
       line-height: 35px;
       padding: 10px 10px 30px 10px;
       text-align: left;
       width: 340px;
     }

     #toggle-drawing {
       width: 27%;
       position: relative;
       margin-left: 10px;
     }

     #zoom-to-area-text {
       position: relative;
       width: 70%;
     }

     #zoom-to-area {
       width: 24%;
     }
   </style>
 </head>
 <body>
   <div class="container">
     <div class="options=box">
       <h1>Find Your New NYC Home</h1>
       <div>
         <input id="show-listings" type="button" value="Show Listings">
         <input id="hide-listings" type="button" value="Show Listings">
         <hr>
         <span class="text"> Draw a shape to search within it for pleces! </span>
         <input id="toggle-drawing" type="button" value="Drawing Tools">
       </div>
      </hr>
      <div>
        <input id="zoom-to-area-text" type="text" placeholder="Enter your favorite area!">
        <input id="zoom-to-area" type="button" value"Zoom">
      </div>
     </div>
     <div id="map"></div>
   </div>
   <script>

   var map;

   // Create a new blank array for all the listing markers.
   var markers = [];

   // This gloabal polygon variable is to ensure only ONE polygon is rendered.
   var polygon = null;

   function initMap() {
     map = new google.maps.Map(document.getElementById('map'), {
       center: {lat: 40.7413549, lng:-73.99802439999996},
       zoom: 8
     });

     // These are the real estate listings that will be shown to the user.
     // Normally we'd have these in a database instead.
     var locations = [
       {title: 'Park Ave Penthouse', location: {lat: 40.7713024, lng: -73.9632393}},
       {title: 'Celsea Lost', location: {lat: 40.7444883, lng: -73.9949465}},
       {title: 'Union Square Open Floor Plan', location: {lat: 40.7347062, lng: -73.9895759}}
     ];

     var largeInfowindow = new google.maps.InfoWindow();

     // Initialize the drawing manager.
     var drawingManager = new google.maps.drawing.DrawingManager({
       drawingMode: google.maps.drawing.OverlayType.POLYGON,
       drawingControl: true,
       drawingControlOptions: {
         position: google.maps.ControlPosition.TOP_LEFT,
         drawingModes: [
           google.maps.drawing.OverlayType.POLYGON
         ]
       }
     });

     var bounds = new google.maps.LatLngBounds();
     // The following group uses the location array to create an array of markers on initalize.
     for (var i = 0; i < locations.length; i++){
       // Get the position from the location array.
       var position  = locations[i].location;
       var title = locations[i].title;
       // Create a marker per location, and put into markers array.
       var marker = new google.maps.Marker({
         position: position,
         title: title,
         animation: google.maps.Animation.DROP,
         id: i
       });
       // Push the marker to our array of markers.
       markers.push(marker);
       // Extend the boundaries of the map for each marker
       bounds.extend(marker.position);
       // Create an onclick event to open an infowindow at each marker.
       marker.addListener('click', function() {
         populateInfowindow(this, largeInfowindow);
       });
     }

     document.getElementById('show-listings').addEventListener('click', showListings);
     document.getElementById('hide-listings').addEventListener('click', hideListings);

     document.getElementById('toggle-drawing').addEventListener('click', function() {
       toggleDrawing(drawingManager);
     });

     document.getElementById('zoom-to-area').addEventListener('click', function(){
       zoomToArea();
     });

     // Add an event listener so that the polygon is captured, call the
     // serachWithinPolygon function. This will show the markers in the polygon,
     // and hide any outside of it.
     drawingManager.addListener('overlaycomplete', function(event) {
       // Fist, check if there is an exitsting polygon.
       // If there is, get rid of it and remove the markers
       if (polygon) {
         polygon.setMap(null);
         hideListings();
       }
       // Switching the drawing mode to ht eHAND (i.e., no longer drawing).
       drawingManager.setDrawingMode(null);
       // Creating a new editable polygon from the overlay.
       polygon = event.overlay;
       polygon.setEditable(true);
       // Searching within the polygon.
       searchWithinPolygon();
       // Make sure the search is re-done if the poly is changed.
       polygon.getPath().addListener('set_at', searchWithinPolygon);
       polygon.getPath().addListener('insert_at', searchWithinPolygon);
     });
   }

    // This function populates the infowindow when the marker is clicked. We'll only allow
    // one infowindow which will open at the marker that is clicked, and populate based
    // on that markers position.
    function populateInfowindow(marker, infowindow) {
      // Check to make sure the infowindow is not aleady open on this marker.
      if (infowindow.marker != marker) {
        infowindow.marker = marker;
        infowindow.setContent('<div>' + marker.title + '</div>');
        infowindow.open(map, marker);
        // Make sure the marker property is cleared if the window is closed.
        infowindow.addListener('closeclock', function() {
         infowindow.setmarker(null);
        });
        var streetViewService = new google.maps.StreetViewService();
        var radius = 50;
        // In case the status is OK, which means the pano was found, compute the
        // position of the streetview image, then calculate the heading, then get a
        // panorama from that and set the options
        function getStreetView(data, status) {
          if (status == google.maps.StreetViewStatus.OK) {
            var nearStreetViewLocation = data.location.latLng;
            var heading = google.maps.geometry.spherical.computeHeading(
              nearStreetViewLocation, marker.position);
            infowindow.setContent('<div>' + marker.title + '</div><div id="pano"></div>');
            var panoramaOptions = {
              position: nearStreetViewLocation,
              pov: {
                heading: heading,
                pitch: 30
              }
            };
            var panorama = new google.maps.StreetViewPanorama (
              document.getElementById('pano'), panoramaOptions);
          } else {
            console.log("it did not work");
            infowindow.setContent('<div>' + marker.title + '</div>' + '<div>No Street View Found</div>');
          }
        }
        // Use streetview service to ge the closest streetview image within
        // 50 meters of the markers position
        streetViewService.getPanoramaByLocation(marker.position, radius, getStreetView);
        // Open the infowindow on the correct marker.
        infowindow.open(map, marker);
      }
    }

    // This function will loop through the markers array and display them all.
    function showListings() {
      var bounds = new google.maps.LatLngBounds();
      // Extend the boundaries of the map for each marker and display the marker
      for (var i = 0; i < markers.length; i++){
        markers[i].setMap(map);
        bounds.extend(markers[i].position);
      }
        map.fitBounds(bounds);
    }

    // This function will loop through the listings and hide them all.
    function hideListings() {
      for (var i = 0; i < markers.length; i++){
        markers[i].setMap(null);
      }
    }

    // This shows and hides (respectively) the drawing options.
    function toggleDrawing(drawingManager) {
      if (drawingManager.map) {
        drawingManager.setMap(null);
        // In case the user drew anything, get rid of the polygon
        if (polygon) {
          polygon.setMap(null);
        }
      } else {
        drawingManager.setMap(map);
      }
    }

    // This functin hides all markers outside the polygon,
    // and shows only the ones within it. This is so that the
    // user can specify an exact area of search
    function serachWithinPolygon() {
      for (var i = 0; i < markers.length; i++) {
        if (googe.maps.geometry.poly.containsLocation(markers[i].position, polygon)) {
          markers[i].setMap(map);
        } else {
          markers[i].setMap(null);
        }
      }
    }

    // This function takes the input value in the find nearby area text input
    // locates it, and then zooms into that ara. This is so that the user can
    // show all listings, then decide to focus on one area of the map.
    function zoomToArea() {
      // Initialize the geocoder.
      var geocoder = new google.maps.Geocoder();
      // Get the address or place that the user entered.
      var address = document.getElementById('zoom-to-area-text').value;
      // Make sure the address isn't blank.
      if (address == ''){
        window.alert('You must enter an area, or address.');
      } else {
        // geocode the address/area entered to get the center. Then, center the map
        // on it and zoom in
        geocoder.geocode(
          { address: address,
            componentRestrictions: {locality: 'New York'}
          }, function(results, status) {
            if (status == google.maps.GeocoderStatus.OK) {
              map.setCenter(result[0].geometry.location);
              map.setZoom(15);
            } else {
              window.alert('We could not find that location - try entering a more specific place.')
            }
          });
      }
    }

   </script>
   <script src="https://maps.googleapis.com/maps/api/js?libraries=drawing,geometry&key=AIzaSyA0BwJCNWr6W--JFwEJm1dLQMpp8C0T_sU&callback=initMap"
    async defer></script>
   <script>
   </script>
 </div>
 </body>
</html>
